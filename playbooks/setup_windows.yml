- name: Setup WinRM Client Cert Authentication
  hosts: windows
  gather_facts: true
  strategy: linear
  vars:
    cert_dir: "{{ playbook_dir }}/../cert"

  tasks:

    - name: Ensure required facts are defined
      ansible.builtin.assert:
        that:
          - username is defined
          - cert_dir is defined

    - name: Check that CA and client certs exist on controller
      ansible.builtin.stat:
        path: "{{ cert_dir }}/{{ item }}.pem"
      delegate_to: localhost
      run_once: true
      register: local_cert_stat
      loop:
        - ca
        - client_cert

    - name: Fail if local certs are missing
      ansible.builtin.assert:
        that:
          - local_cert_stat.results[0].stat.exists
          - local_cert_stat.results[1].stat.exists
      run_once: true

    - name: Generate local user password
      ansible.builtin.set_fact:
        user_password: "{{ lookup('ansible.builtin.password', cert_dir ~ '/user_password', length=15) }}"

    - name: Ensure local user exists
      ansible.windows.win_user:
        name: "{{ username }}"
        groups:
          - Administrators
          - Users
        password: "{{ user_password }}"
        update_password: always
        password_never_expires: true
        user_cannot_change_password: true

    - name: Copy CA and client certs to remote host
      ansible.windows.win_copy:
        src: "{{ cert_dir }}/{{ item }}.pem"
        dest: "C:\\Windows\\TEMP\\{{ item }}.pem"
      loop:
        - ca
        - client_cert
      register: copy_results

    - name: Import CA as Trusted Root (idempotent)
      ansible.windows.win_certificate_store:
        path: C:\Windows\TEMP\ca.pem
        state: present
        store_location: LocalMachine
        store_name: Root

    - name: Trust client certificate (idempotent)
      ansible.windows.win_certificate_store:
        path: C:\Windows\TEMP\client_cert.pem
        state: present
        store_location: LocalMachine
        store_name: TrustedPeople
      register: client_cert_info

    - name: Enable WinRM Certificate Auth (idempotent)
      ansible.windows.win_powershell:
        script: |
          $authPath = 'WSMan:\localhost\Service\Auth\Certificate'
          if ((Get-Item -LiteralPath $authPath).Value -ne $true) {
              Set-Item -LiteralPath $authPath -Value $true
          }

    - name: Map client certificate to user (idempotent)
      ansible.windows.win_powershell:
        script: |
          $thumb = "{{ client_cert_info.thumbprints[0] }}"
          $existing = Get-ChildItem WSMan:\localhost\ClientCertificate | Where-Object {$_.Thumbprint -eq $thumb}
          if (-not $existing) {
            winrm set winrm/config/service/certmapping @{CertificateThumbprint=$thumb;UserName="{{ username }}"}
          }

    - name: Generate WinRM inventory file (controller only)
      ansible.builtin.template:
        src: cert_inventory.ini.j2
        dest: "{{ playbook_dir }}/cert_inventory.ini"
        mode: '0600'
      delegate_to: localhost
      run_once: true

    - name: Output summary
      ansible.builtin.debug:
        msg: >
          WinRM service configured for '{{ username }}'.
          Inventory file created at '{{ playbook_dir }}/cert_inventory.ini'.
