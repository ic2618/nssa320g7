- name: Setup WinRM Client Cert Authentication
  hosts: windows
  gather_facts: true
  strategy: linear

  vars:
    cert_dir: "/home/student/project/nssa320g7/cert"

  tasks:

    # -------------------------------------------------------------------------
    # VALIDATION: Ensure variables are defined
    # -------------------------------------------------------------------------
    - name: Validate required vars
      ansible.builtin.assert:
        that:
          - username is defined
          - cert_dir is defined
        fail_msg: "username or cert_dir variable missing."


    # -------------------------------------------------------------------------
    # VALIDATION: Ensure CA + client cert exist on controller
    # -------------------------------------------------------------------------
    - name: Check local cert files exist
      ansible.builtin.stat:
        path: "{{ cert_dir }}/{{ item }}.pem"
      delegate_to: localhost
      loop:
        - ca
        - client_cert
      register: cert_stats

    - name: Fail if CA or client cert missing
      ansible.builtin.assert:
        that:
          - cert_stats.results[0].stat.exists
          - cert_stats.results[1].stat.exists
        fail_msg: "CA or client certificate missing in {{ cert_dir }}."
      run_once: true


    # -------------------------------------------------------------------------
    # Create Windows user for cert auth
    # -------------------------------------------------------------------------
    - name: Generate local password for Windows cert-auth user
      ansible.builtin.set_fact:
        user_password: "{{ lookup('ansible.builtin.password', cert_dir ~ '/user_password', length=15) }}"

    - name: Ensure Windows user exists
      ansible.windows.win_user:
        name: "{{ username }}"
        groups:
          - Administrators
          - Users
        password: "{{ user_password }}"
        update_password: always
        password_never_expires: true
        user_cannot_change_password: true


    # -------------------------------------------------------------------------
    # Copy CA + client cert to Windows
    # -------------------------------------------------------------------------
    - name: Copy cert PEMs to Windows TEMP
      ansible.windows.win_copy:
        src: "{{ cert_dir }}/{{ item }}.pem"
        dest: "C:\\Windows\\TEMP\\{{ item }}.pem"
      loop:
        - ca
        - client_cert
      register: cert_copy_results

    - name: Validate cert copy succeeded
      ansible.builtin.assert:
        that: "{{ cert_copy_results.results | map(attribute='changed') | list | length > 0 }}"
        fail_msg: "Certificate copy to Windows failed."


    # -------------------------------------------------------------------------
    # Import CA into Trusted Root
    # -------------------------------------------------------------------------
    - name: Import CA cert into Trusted Root
      ansible.windows.win_certificate_store:
        path: C:\Windows\TEMP\ca.pem
        store_location: LocalMachine
        store_name: Root
        state: present
      register: ca_import

    - name: Validate CA import success
      ansible.builtin.assert:
        that:
          - ca_import is defined
        fail_msg: "CA certificate import failed."


    # -------------------------------------------------------------------------
    # Import client certificate into TrustedPeople
    # -------------------------------------------------------------------------
    - name: Import client certificate into TrustedPeople
      ansible.windows.win_certificate_store:
        path: C:\Windows\TEMP\client_cert.pem
        store_location: LocalMachine
        store_name: TrustedPeople
        state: present
      register: client_import

    - name: Validate client cert import success
      ansible.builtin.assert:
        that:
          - client_import is defined
        fail_msg: "Client certificate import failed."


    # -------------------------------------------------------------------------
    # Extract thumbprint from imported certificate safely
    # -------------------------------------------------------------------------
    - name: Retrieve thumbprint from certificate store
      ansible.windows.win_powershell:
        script: |
          $pattern = "*CN={{ username }}*"
          $matches = Get-ChildItem -Path Cert:\LocalMachine\TrustedPeople |
                     Where-Object { $_.Subject -like $pattern -and $_.NotAfter -gt (Get-Date) } |
                     Sort-Object NotBefore -Descending
          if ($matches -and $matches.Count -gt 0) {
            $cert = $matches[0]
            $cert.Thumbprint
          } else { "NONE" }
      register: client_thumb

    - name: Fail if thumbprint cannot be extracted
      ansible.builtin.assert:
        that:
          - client_thumb.output[0] != "NOT_FOUND"
        fail_msg: "Client certificate imported, but thumbprint cannot be retrieved."


    # -------------------------------------------------------------------------
    # Enable WinRM Certificate Authentication
    # -------------------------------------------------------------------------
    - name: Enable WinRM certificate authentication
      ansible.windows.win_powershell:
        script: |
          $path = "WSMan:\localhost\Service\Auth\Certificate"
          $current = (Get-Item -LiteralPath $path).Value
          if ($current -ne $true) {
            Set-Item -LiteralPath $path -Value $true
          }
      register: winrm_cert_auth

    - name: Validate WinRM cert-auth enabled
      ansible.windows.win_powershell:
        script: |
          (Get-Item -LiteralPath 'WSMan:\localhost\Service\Auth\Certificate').Value
      register: winrm_auth_status

    - name: Fail if WinRM cert-auth did not enable
      ansible.builtin.assert:
        that:
          - winrm_auth_status.output[0] | bool
        fail_msg: "WinRM certificate authentication was NOT enabled!"


    # -------------------------------------------------------------------------
    # Map certificate â†’ user
    # -------------------------------------------------------------------------
    - name: Map certificate thumbprint to user (idempotent)
      ansible.windows.win_powershell:
        script: |
          # Create needed variables
          $thumb = "{{ client_thumb.output[0] }}"
          # Get client certificate object
          $clientCert = Get-Item "Cert:\LocalMachine\TrustedPeople\$thumb"
          $subject = $clientCert.GetNameInfo('UpnName', $false)

          $certChain = New-Object -TypeName Security.Cryptography.X509Certificates.X509Chain
          [void]$certChain.Build($clientCert)
          $caThumbprint = $certChain.ChainElements.Certificate[-1].Thumbprint

          # Enumerate all certificate mappings
          $allMappings = Get-ChildItem WSMan:\localhost\ClientCertificate | ForEach-Object { $_ | Get-Item }
          $existing = $false

          # Loop through all mappings
          foreach($mapping in $allMappings){
              $map = $mapping | Get-Item

              # WSMan Keys come in fixed order:
              # 0 - URI
              # 1 - Issuer-xxxxx
              # 2 - Subject-xxxx

              # Extract values AFTER "="
              $issuerParts = $map.Keys[1] -split "=", 2
              $subjectParts = $map.Keys[2] -split "=", 2

              $issuerValue = $issuerParts[1]
              $subjectValue = $subjectParts[1]

              if($issuerValue -eq $caThumbprint -and $subjectValue -like $subject) {
                  $existing = $true
              }

          }


          if (-not $existing) {
              # Create Credential for Cert
              $user = "{{ username }}"
              $password = "{{ user_password }}"
              $securePass = ConvertTo-SecureString $password -AsPlainText -Force
              $credential = New-Object System.Management.Automation.PSCredential ($user,$securePass)

              # Certificate mapping
              $certMapping = @{
                  Path = 'WSMan:\localhost\ClientCertificate'
                  Subject = $subject
                  Issuer = $caThumbprint
                  Credential = $credential
                  Force = $true
            }
            $null = New-Item @certMapping

            # Ouput info for Ansible
            [PSCustomObject]@{
                Status      = "CREATED"
                Thumbprint  = $thumb
                Subject     = $subject
                IssuerThumb = $caThumbprint
                Username    = $user
            }
          } else {
            $existingMapping = $existing | Select-Object Thumbprint, Subject, Issuer, Enabled
            [PSCustomObject]@{
                Status      = "EXISTS"
                Thumbprint  = $existingMapping.Thumbprint
                Subject     = $existingMapping.Thumbprint
                IssuerThumb = $existingMapping.Issuer
                Enabled     = $existingMapping.Enabled
            }
          }
      register: certmap_result

    # ------------------------------------------------------------------------
    # Validate Certificate Mapping
    # ------------------------------------------------------------------------

    - name: Validate certificate mapping
      ansible.windows.win_powershell:
        script: |
          # Create needed variables
          $thumb = "{{ client_thumb.output[0] }}"
          # Get client certificate object
          $clientCert = Get-Item "Cert:\LocalMachine\TrustedPeople\$thumb"
          $subject = $clientCert.GetNameInfo('UpnName', $false)

          $certChain = New-Object -TypeName Security.Cryptography.X509Certificates.X509Chain
          [void]$certChain.Build($clientCert)
          $caThumbprint = $certChain.ChainElements.Certificate[-1].Thumbprint

          # Enumerate all certificate mappings
          $allMappings = Get-ChildItem WSMan:\localhost\ClientCertificate | ForEach-Object { $_ | Get-Item }
          $existing = $false

          # Loop through all mappings
          foreach($mapping in $allMappings){
              $map = $mapping | Get-Item

              # WSMan Keys come in fixed order:
              # 0 - URI
              # 1 - Issuer-xxxxx
              # 2 - Subject-xxxx

              # Extract values AFTER "="
              $issuerParts = $map.Keys[1] -split "=", 2
              $subjectParts = $map.Keys[2] -split "=", 2

              $issuerValue = $issuerParts[1]
              $subjectValue = $subjectParts[1]

              if($issuerValue -eq $caThumbprint -and $subjectValue -like $subject) {
                  $existing = $true
              }

          }
          if ($existing) { "OK" } else { "NOT MAPPED" }
      register: certmap_check

    - name: Fail if cert not mapped to user
      ansible.builtin.assert:
        that:
          - certmap_check.output[0] == "OK"
        fail_msg: "Client certificate failed to map to user {{ username }}."


    # -------------------------------------------------------------------------
    # Generate cert-only inventory for windows hosts
    # -------------------------------------------------------------------------
    - name: Generate WinRM cert-auth inventory file
      ansible.builtin.template:
        src: ../templates/cert_inventory.ini.j2
        dest: "./../cert_inventory.ini"
        mode: '0600'
      delegate_to: localhost
      run_once: true


    # -------------------------------------------------------------------------
    # Final summary
    # -------------------------------------------------------------------------
    - name: Summary
      ansible.builtin.debug:
        msg: |
          WinRM certificate authentication successfully configured for Windows host.
          User: {{ username }}
          Thumbprint: {{ client_thumb.output[0] }}
          Inventory generated: {{ playbook_dir }}/cert_inventory.ini
