- name: Setup Certificates
  hosts: localhost
  gather_facts: false
  vars:
    cert_dir: "/home/student/project/nssa320g7/cert"
  tasks:

    # -------------------------------------------------------------------
    # Verify required facts
    # -------------------------------------------------------------------
    - name: Verify required facts are setup
      ansible.builtin.assert:
        that:
          - username is defined
          - playbook_dir is defined
          - cert_dir is defined

    - name: Show directories
      ansible.builtin.debug:
        msg: "Playbook Directory: {{ playbook_dir }}\nCertificate Directory: {{ cert_dir }}"

    # -------------------------------------------------------------------
    # Ensure cert directory exists
    # -------------------------------------------------------------------
    - name: Create certificate output dir
      ansible.builtin.file:
        path: "{{ cert_dir }}"
        state: directory
        owner: "{{ ansible_user | default('student') }}"
        group: "{{ ansible_user | default('student') }}"
        mode: '0700'

    # -------------------------------------------------------------------
    # Generate password for certificate private keys
    # -------------------------------------------------------------------
    - name: Generate certificate key password
      ansible.builtin.set_fact:
        certificate_password: "{{ lookup('ansible.builtin.password', cert_dir ~ '/cert_password', length=15) }}"

    # -------------------------------------------------------------------
    # Check if CA files exist
    # -------------------------------------------------------------------
    - name: Check if CA private key exists
      ansible.builtin.stat:
        path: "{{ cert_dir }}/ca.key"
      register: ca_key_stat

    - name: Check if CA certificate exists
      ansible.builtin.stat:
        path: "{{ cert_dir }}/ca.pem"
      register: ca_cert_stat

    # -------------------------------------------------------------------
    # CA PRIVATE KEY
    # -------------------------------------------------------------------
    - name: Create CA private key if missing
      community.crypto.openssl_privatekey:
        path: "{{ cert_dir }}/ca.key"
        passphrase: "{{ certificate_password }}"
        cipher: auto
      when: not ca_key_stat.stat.exists

    # -------------------------------------------------------------------
    # CA CSR (generated in memory, no file check needed)
    # -------------------------------------------------------------------

    - name: Check if CA CSR Exists (ca_csr.csr)
      ansible.builtin.stat:
        path: '{{ cert_dir }}/ca_csr.csr'
      register: ca_csr_stat

    - name: Create CA CSR
      community.crypto.openssl_csr_pipe:
        privatekey_path: "{{ cert_dir }}/ca.key"
        privatekey_passphrase: "{{ certificate_password }}"
        common_name: "WinRM Cert Auth CA"
        use_common_name_for_san: false
        basic_constraints:
          - "CA:TRUE"
        basic_constraints_critical: true
        key_usage:
          - keyCertSign
        key_usage_critical: true
      register: ca_csr
      when: ca_key_stat.stat.exists and not ca_csr_stat.stat.exists

    # -------------------------------------------------------------------
    # CA CERTIFICATE
    # -------------------------------------------------------------------
    - name: Create CA certificate from CSR if missing
      community.crypto.x509_certificate:
        path: "{{ cert_dir }}/ca.pem"
        csr_content: "{{ ca_csr.csr }}"
        privatekey_path: "{{ cert_dir }}/ca.key"
        privatekey_passphrase: "{{ certificate_password }}"
        provider: selfsigned
      when: ca_csr_stat.stat.exists and not ca_cert_stat.stat.exists

    # -------------------------------------------------------------------
    # CLIENT PRIVATE KEY
    # -------------------------------------------------------------------
    - name: Check if client private key exists
      ansible.builtin.stat:
        path: "{{ cert_dir }}/client_cert.key"
      register: client_key_stat

    - name: Create client certificate private key if missing
      community.crypto.openssl_privatekey:
        path: "{{ cert_dir }}/client_cert.key"
        passphrase: "{{ certificate_password }}"
        cipher: auto
      when: not client_key_stat.stat.exists

    # -------------------------------------------------------------------
    # CLIENT CSR
    # -------------------------------------------------------------------
    - name: Create client certificate CSR
      community.crypto.openssl_csr_pipe:
        privatekey_path: "{{ cert_dir }}/client_cert.key"
        privatekey_passphrase: "{{ certificate_password }}"
        common_name: "{{ username }}"
        extended_key_usage:
          - clientAuth
        subject_alt_name: "otherName:1.3.6.1.4.1.311.20.2.3;UTF8:{{ username }}@localhost"
      register: cert_auth_csr
      when: client_key_stat.stat.exists and not cert_auth_csr_stat.stat.exists

    # -------------------------------------------------------------------
    # CLIENT CERTIFICATE
    # -------------------------------------------------------------------
    - name: Check if client certificate exists
      ansible.builtin.stat:
        path: "{{ cert_dir }}/client_cert.pem"
      register: client_cert_stat

    - name: Check if client auth csr exists
      ansible.builtin.stat:
        path: '{{ cert_dir }}/cert_auth_csr.csr'
      register: cert_auth_csr_stat

    - name: Create client certificate from CSR if missing
      community.crypto.x509_certificate:
        path: "{{ cert_dir }}/client_cert.pem"
        csr_content: "{{ cert_auth_csr.csr }}"
        provider: ownca
        ownca_path: "{{ cert_dir }}/ca.pem"
        ownca_privatekey_path: "{{ cert_dir }}/ca.key"
        ownca_privatekey_passphrase: "{{ certificate_password }}"
        ownca_not_after: +365d
        ownca_not_before: '-1d'
      when: cert_auth_csr_stat.stat.exists and not client_cert_stat.stat.exists

    # -------------------------------------------------------------------
    # STRIP PASSPHRASE
    # -------------------------------------------------------------------
    - name: Strip passphrase from client certificate key
      ansible.builtin.command:
        cmd: >-
          openssl rsa
          -in client_cert.key
          -out client_cert_no_pass.key
          -passin pass:{{ certificate_password }}
        chdir: "{{ cert_dir }}"
        creates: "{{ cert_dir }}/client_cert_no_pass.key"

    # -------------------------------------------------------------------
    # SUMMARY
    # -------------------------------------------------------------------
    - name: Output summary
      ansible.builtin.debug:
        msg: |
          CA and Client Certificate have been generated at {{ cert_dir }}
          CA Key:               {{ cert_dir }}/ca.key
          CA Cert:              {{ cert_dir }}/ca.pem
          Client cert:          {{ cert_dir }}/client_cert.pem
          Client key:           {{ cert_dir }}/client_cert_no_pass.key
          Private key password: {{ certificate_password }}
